---
- name: Install Cilium CNI Plugin
  hosts: control_plane[0]

  tasks:
    - name: Check if Cilium CLI is already installed
      stat:
        path: /usr/local/bin/cilium
      register: cilium_cli_binary

    - name: Download Cilium CLI
      get_url:
        url: "https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz"
        dest: /tmp/cilium-linux-amd64.tar.gz
        mode: '0644'
      when: not cilium_cli_binary.stat.exists

    - name: Extract Cilium CLI
      unarchive:
        src: /tmp/cilium-linux-amd64.tar.gz
        dest: /usr/local/bin
        remote_src: yes
        mode: '0755'
      when: not cilium_cli_binary.stat.exists

    - name: Verify Cilium CLI binary exists
      stat:
        path: /usr/local/bin/cilium
      register: cilium_cli_verify
      failed_when: not cilium_cli_verify.stat.exists

    - name: Verify Cilium CLI installation
      command: /usr/local/bin/cilium version --client
      register: cilium_cli_version
      changed_when: false

    - name: Display Cilium CLI version
      debug:
        var: cilium_cli_version.stdout_lines

    - name: Check if Cilium is already installed
      command: kubectl get daemonset cilium -n kube-system
      register: cilium_daemonset_check
      changed_when: false
      failed_when: false
      become_user: devops

    - name: Install Cilium using Cilium CLI
      command: >
        /usr/local/bin/cilium install
        --version {{ cilium_version }}
        --set ipam.mode=kubernetes
        --set routingMode={{ cilium_tunnel_mode }}
        --set ipv4.enabled={{ cilium_enable_ipv4 | lower }}
        --set ipv6.enabled={{ cilium_enable_ipv6 | lower }}
        --set operator.replicas={{ cilium_operator_replicas }}
        --set kubeProxyReplacement={{ 'true' if cilium_kube_proxy_replacement in ['strict', 'true', True] else 'false' }}
        --set bandwidthManager.enabled={{ cilium_enable_bandwidth_manager | lower }}
        --set hubble.enabled={{ cilium_enable_hubble | lower }}
        --set hubble.relay.enabled={{ cilium_enable_hubble | lower }}
        --set hubble.ui.enabled={{ cilium_hubble_ui | lower }}
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      when: cilium_daemonset_check.rc != 0
      register: cilium_install_result

    - name: Display Cilium installation output
      debug:
        var: cilium_install_result.stdout_lines
      when: cilium_install_result is changed

    - name: Wait for Cilium to be ready
      command: /usr/local/bin/cilium status --wait
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cilium_status
      retries: 30
      delay: 10
      until: cilium_status.rc == 0
      changed_when: false

    - name: Display Cilium status
      debug:
        var: cilium_status.stdout_lines

    - name: Run Cilium connectivity test (optional, can take 5-10 minutes)
      command: /usr/local/bin/cilium connectivity test --test-concurrency=1
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cilium_connectivity
      changed_when: false
      failed_when: false
      when: false  # Set to true to run connectivity test

    - name: Get Cilium pods
      command: kubectl get pods -n kube-system -l k8s-app=cilium
      register: cilium_pods
      changed_when: false
      become_user: devops

    - name: Display Cilium pods
      debug:
        var: cilium_pods.stdout_lines

    - name: Check if Hubble UI is enabled
      command: kubectl get service -n kube-system hubble-ui
      register: hubble_ui_check
      changed_when: false
      failed_when: false
      become_user: devops
      when: cilium_hubble_ui | bool

    - name: Display Cilium installation summary
      debug:
        msg:
          - "=== Cilium CNI Installed Successfully ==="
          - "Cilium Version: {{ cilium_version }}"
          - "Routing Mode: {{ cilium_tunnel_mode }}"
          - "Kube-proxy Replacement: {{ cilium_kube_proxy_replacement }}"
          - "Hubble Observability: {{ 'Enabled' if cilium_enable_hubble else 'Disabled' }}"
          - ""
          - "Check Cilium status: cilium status"
          - "View Cilium pods: kubectl get pods -n kube-system -l k8s-app=cilium"
          - "View all nodes: kubectl get nodes"
          - "Verify connectivity (optional): cilium connectivity test"
      when: cilium_install_result is changed or cilium_status is success

    - name: Display Hubble UI access instructions
      debug:
        msg:
          - "Access Hubble UI:"
          - "  kubectl port-forward -n kube-system svc/hubble-ui 12000:80"
          - "  Then open: http://localhost:12000"
      when: (cilium_install_result is changed or cilium_status is success) and cilium_hubble_ui

    - name: Verify nodes are Ready
      command: kubectl get nodes
      register: nodes_status
      changed_when: false
      become_user: devops

    - name: Display nodes status
      debug:
        var: nodes_status.stdout_lines
