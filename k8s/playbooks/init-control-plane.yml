---
- name: Initialize Kubernetes Control Plane
  hosts: control_plane[0]  # Only run on the first control plane node

  tasks:
    - name: Check if Kubernetes is already initialized
      stat:
        path: /etc/kubernetes/admin.conf
      register: k8s_admin_conf

    - name: Initialize Kubernetes cluster
      command: >
        kubeadm init
        --pod-network-cidr={{ pod_network_cidr }}
        --service-cidr={{ service_cidr }}
        --apiserver-advertise-address={{ ansible_default_ipv4.address }}
        {{ kubeadm_init_extra_args }}
      register: kubeadm_init
      when: not k8s_admin_conf.stat.exists

    - name: Display kubeadm init output
      debug:
        var: kubeadm_init.stdout_lines
      when: kubeadm_init is changed

    - name: Create .kube directory for root user
      file:
        path: /root/.kube
        state: directory
        mode: '0755'

    - name: Copy admin.conf to root user's kube config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: yes
        owner: root
        group: root
        mode: '0600'

    - name: Create .kube directory for devops user
      file:
        path: /home/devops/.kube
        state: directory
        owner: devops
        group: devops
        mode: '0755'

    - name: Copy admin.conf to devops user's kube config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/devops/.kube/config
        remote_src: yes
        owner: devops
        group: devops
        mode: '0600'

    - name: Generate join command for worker nodes
      command: kubeadm token create --print-join-command
      register: join_command
      changed_when: false

    - name: Save join command to local file
      local_action:
        module: copy
        content: "{{ join_command.stdout }}"
        dest: /tmp/k8s-join-command.sh
        mode: '0755'
      become: no

    - name: Display join command
      debug:
        msg: "Worker join command saved to /tmp/k8s-join-command.sh"

    - name: Generate certificate key for control plane join
      command: kubeadm init phase upload-certs --upload-certs
      register: certificate_key_output
      changed_when: false

    - name: Extract certificate key
      set_fact:
        certificate_key: "{{ certificate_key_output.stdout_lines[-1] }}"

    - name: Generate join command for additional control plane nodes
      command: >
        kubeadm token create --print-join-command
        --certificate-key {{ certificate_key }}
      register: cp_join_command
      changed_when: false

    - name: Save control plane join command to local file
      local_action:
        module: copy
        content: "{{ cp_join_command.stdout }} --control-plane --certificate-key {{ certificate_key }}"
        dest: /tmp/k8s-cp-join-command.sh
        mode: '0755'
      become: no

    - name: Display control plane join command location
      debug:
        msg: "Control plane join command saved to /tmp/k8s-cp-join-command.sh"

    - name: Verify cluster status
      command: kubectl get nodes
      register: cluster_nodes
      changed_when: false
      become_user: devops

    - name: Display cluster nodes
      debug:
        var: cluster_nodes.stdout_lines

    - name: Display next steps
      debug:
        msg:
          - "=== Control Plane Initialized ==="
          - "1. Install a CNI plugin (Calico, Flannel, etc.)"
          - "2. Join additional control plane nodes using: /tmp/k8s-cp-join-command.sh"
          - "3. Join worker nodes using: /tmp/k8s-join-command.sh"
          - "4. Run 'kubectl get nodes' to verify cluster status"
